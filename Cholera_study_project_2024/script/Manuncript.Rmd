---
title: "old code"
author: "Selemani Ngwira"
date: "2024-12-16"
output:
  word_document: default
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


if(!require(pacman)) install.packages("pacman")

p_load(
  tidyverse,
  here,
  summarytools,
  janitor,
  sf, 
  terra,
  tmap,
  OpenStreetMap,
  flextable,
  rio, 
  gtsummary, 
  epikit, 
  pwr, 
  webshot2,
  gtsummary, 
   BiocManager,
  ggradar,
  scales,
  fmsb,
  officer)
 

install.packages("cardx")

conflicted::conflict_prefer("select", "dplyr")

conflicted::conflicts_prefer(stats::fisher.test)

options("max.print" = 10000)  # Increase the print limit


```

# loading data


```{r cars}

# importing the data 
cholera_data<-import(here("data/cholera_data_.csv")) %>%
                clean_names() %>% 
  mutate(district=recode(
      district, 
      "Blantyre_City"="Blantyre"
    )) %>% 
   mutate(residence = case_when(
    district %in% c("Lilongwe", "Blantyre", "Dedza", "Bakala") ~ "in_land",
    TRUE ~ "lake_share" )) 

# changing the data.frame into tibble object for easy handling 
cholera_data<- tibble(cholera_data)



# filtering out those less than 18 years 
cholera_data<-cholera_data %>% 
  dplyr::filter(age_group!="<18")


district_shapefile<-sf:: st_read(
  here("data/MWI_adm1.shp")
) %>% 
  select(
   NAME_1,
    ID_0,
    ID_1) %>% 
  dplyr::rename(
    "District"= NAME_1
  )



```

# Social and behavioral factors that influence current water treatment practices

## Source of Water for Daily use by District   


```{r pressure, echo=FALSE}

names(cholera_data)

  table(cholera_data$water_treatment_category) 


```


## Awareness of the Health Risk Associated with drinking untreated Water by Sex, Age-Group, Level of Education. 

```{r}

awareness_of_heathRisk_demo<-cholera_data %>% 
                 select(
                   sex, 
                   age_group, 
                   level_education, 
                   ethnicity,
                  health_risk_associated_with_drinking_untreated_water
                 )


grouding_vars <- c("sex", "age_group", "level_education",
                   "ethnicity")


table2<-awareness_of_heathRisk_demo %>% 
  create_summary_table3(grouding_vars, "health_risk_associated_with_drinking_untreated_water",
                        sum = T)



table2<- table2 %>% 
  flextable() %>% 
  autofit() %>% 
  set_table_properties(layout = "autofit") %>% 
  height_all(height =  0.5, unit = "in" ) 


save_as_docx(table2, path = here("output/table2.docx"))


print(table2)


```


## Awareness of the Health Risk Associated with drinking untreated Water by district 


```{r}

table3<-awareness_of_heathRisk %>% 
      select(district , 
             residence, health_risk_associated_with_drinking_untreated_water) 


grouping_vars <- c("district", "residence")



table3<- table3<- create_summary_table3(table3, grouping_vars, "health_risk_associated_with_drinking_untreated_water", sum = T)

table3<- table3 %>%
  flextable() %>%
  autofit() %>%
  set_table_properties(layout = "autofit") %>%
  height_all(height = 0.5, unit = "in")


save_as_docx(table3, path = here("output/table3.docx"))

print(table3)


```




## 2.3. 0 Main sources of drinking water during the dry season by District/ Township 

```{r}
drinking_dry<-cholera_data %>% 
  select(district, 
         residence, 
         main_source_of_drinking_water_dry_season)


grouding_vars <- c("district", "residence")

drinking_dry<- drinking_dry %>% 
  create_summary_table3(grouding_vars, "main_source_of_drinking_water_dry_season", sum = T)

   drinking_dry<-drinking_dry %>%
  rename_with(~ str_replace_all(., "_", " "))


table4<-drinking_dry %>% 
  flextable() %>% 
  autofit() %>% 
  set_table_properties(layout = "autofit") %>% 
  height_all(height = 0.5, unit = "in")


save_as_docx(table4, path = here("output/table4.docx"))

print(table4)


gsub("main_source_of_drinking_water_dry_season_", "", drinking_dry$main_source_of_drinking_water_dry_season)

```


## 2.4. 0 Main sources of drinking water during the wet season by District

```{r}

wet_drink_district <- cholera_data %>% 
                      select(district, 
                             residence,
                             main_source_of_drinking_water_wet_season)


grouping_vars <- c("district", "residence")

wet_drink_district<- wet_drink_district %>% 
  create_summary_table3(grouping_vars, "main_source_of_drinking_water_wet_season",
                        sum = T)

  wet_drink_district<-wet_drink_district %>%
  rename_with(~ str_replace_all(., "_", " "))


   
table5<- wet_drink_district %>%  
  flextable() %>% 
  autofit() %>% 
  set_table_properties(layout = "autofit") %>% 
  height_all(height = 0.5, unit = "in")

save_as_docx(table5, path = here("output/table5.docx"))
   
print(table5)




```

## 2.5.1 Water Treatment at Household by Sex, Level of Education, Religion

```{r}

Water_treat<-cholera_data %>% 
         select(sex, 
                age_group, 
                level_education, 
                ethnicity, 
                treat_drinking_water)

grouding_vars_demo <- c("sex", "age_group", "level_education", "ethnicity")


table6<- Water_treat %>% 
  create_summary_table3(grouding_vars_demo,
                        "treat_drinking_water", 
                        sum = T)


table6<- table6 %>% 
  flextable() %>% 
  autofit() %>% 
  set_table_properties(layout = "autofit") %>% 
  height_all(height = 0.5, unit = "in")


save_as_docx(table6, path = here("output/table6.docx"))

print(table6)

```


## 2.5.2 Water Treatment at Household by District 

```{r}
 


Water_treat_district_zone<-cholera_data %>% 
         select(district, 
                residence, 
                treat_drinking_water)




table7 <- Water_treat_district_zone%>% 
  create_summary_table3(grouding_vars,
                        "treat_drinking_water", 
                        sum = T)

table7<- table7 %>% 
  flextable() %>%
  autofit() %>%
  set_table_properties(layout = "autofit") %>%
  height_all(height = 0.5, unit = "in")

save_as_docx(table7, path = here("output/table7.docx"))

```


## 2.5.3 if yes, Methods of water treatment by District

```{r}

```


```{r, fig.height=7, fig.width=14}
methods_water <- cholera_data %>% 
               select(
                 sex,
                  age_group, 
                  level_education, 
                  ethnicity, 
                 c(34:41)
               )

methods_water<- methods_water %>% 
  pivot_longer(
    cols = (5:12), 
    names_to = "method_of_water_treatment"
  ) %>% 
  filter(value==1) %>% 
  select(sex, age_group,
         level_education,
         ethnicity, 
         method_of_water_treatment) 


methods_water$method_of_water_treatment<- gsub("method_of_water_treatment_", "", methods_water$method_of_water_treatment)


methods_water<- methods_water %>% 
  create_summary_table3(grouding_vars_demo, 
                        "method_of_water_treatment",
                        sum = T)


table8<- methods_water %>% 
  flextable() %>% 
  autofit() %>% 
  set_table_properties(layout = "autofit") %>% 
  height_all(height = 0.5, unit = "in")


save_as_docx(table8, path = here("output/table8.docx"))

table8
```


```{r}

methods_water_district <- cholera_data %>% 
               select(
                 district, 
                 residence,
                 c(34:41)
               )



table9<- methods_water_district %>% 
  pivot_longer(
    cols = (3:10), 
    names_to = "method_of_water_treatment"
  ) %>% 
  dplyr:: filter(value==1) %>% 
 dplyr:: select(district, 
         residence, 
         method_of_water_treatment)

table9$method_of_water_treatment<-gsub("method_of_water_treatment_",
                                        "",
                                      table9$method_of_water_treatment)

table9<- table9 %>%
  create_summary_table3(grouding_vars, 
                        "method_of_water_treatment",
                        sum = T)


table9<- table9 %>% 
  flextable() %>%
  autofit() %>%
  set_table_properties(layout = "autofit") %>%
  height_all(height = 0.5, unit = "in")


save_as_docx(table9, path = here("output/table9.docx"))

```




##2.5.4 Properly chlorination process by district.


```{r}
properly_chro_district <- cholera_data %>% 
            select(district, 
                   residence,
                   chlorination_process_done_correctly)


table10<- properly_chro_district %>% 
         create_summary_table3(grouding_vars, 
                               "chlorination_process_done_correctly",
                               sum = T)

table10<-table10 %>% 
  flextable() %>% 
  autofit() %>% 
  set_table_properties(layout = "autofit") %>% 
  height_all(height = 0.5, unit = "in")


save_as_docx(table10, path = here("output/table10.docx"))


```



##2.5.4 Properly chlorination process by Sex, Education, Age group and ethnicity

```{r}
## by Sex, Age and Education 


properly_chro_demo<-cholera_data %>% 
            select(sex,
                   age_group, 
                   level_education, 
                   ethnicity,
                   chlorination_process_done_correctly)


table11<- properly_chro_demo %>% 
    create_summary_table3(grouding_vars_demo, 
                          "chlorination_process_done_correctly",
                          sum = T)

table11<-table11 %>%
  flextable() %>%
  autofit() %>%
  set_table_properties(layout = "autofit") %>%
  height_all(height = 0.5, unit = "in")




save_as_docx(table11, path = here("output/table11.docx"))


```

## 2.5. 5 Frequency of water treatment by Sex, Level of Education, Religion, ethnicity


```{r}
freq_water_treatment <- cholera_data %>% 
                        select(
                          sex, 
                          age_group, 
                          level_education, 
                          religion,
                          ethnicity,
                        often_treat_water
                        )


grouding_vars_demo <- c("sex",
                        "age_group", 
                        "level_education", 
                        "religion", 
                        "ethnicity")


table14<- freq_water_treatment %>% 
  create_summary_table3(grouding_vars_demo, 
                        "often_treat_water",
                        sum = T)

table14<- table14 %>% 
  flextable() %>% 
  autofit() %>% 
  set_table_properties(layout = "autofit") %>% 
  height_all(height = 0.5, unit = "in")


save_as_docx(table14, path = here("output/table14.docx"))

```


## 2.5. 5 Frequency of water treatment by districts


```{r}
freq_water_treatment_district <- cholera_data %>% 
                                select(
                                  district,
                                  residence,
                                  often_treat_water
                                )




table15<- freq_water_treatment_district %>% 
           create_summary_table3(grouding_vars, 
                                 "often_treat_water",
                                 sum = T)

table15<- table15 %>% 
  flextable() %>% 
  autofit() %>% 
  set_table_properties(layout = "autofit") %>% 
  height_all(height = 0.5, unit = "in")


save_as_docx(table15, path = here("output/table15.docx"))



```

## 2. 5.6 Access to water treatment product by district 

```{r}

Access_to_water_treatment_pt<-cholera_data %>% 
            select(district, 
                   residence, 
                   difficulties_accessing_water_treatment_products)


table16<- Access_to_water_treatment_pt %>% 
  create_summary_table3(grouding_vars,                         "difficulties_accessing_water_treatment_products",
                        sum = T)
    
table16<- table16 %>% 
  flextable() %>%
  autofit() %>%
  set_table_properties(layout = "autofit") %>%
  height_all(height = 0.5, unit = "in")

save_as_docx(table16, path = here("output/table16.docx"))



```

## 2. 6.0 Knowledge of cholera calendar year.  By Sex, Level of Education, Religion 

```{r}

knowledge_on_cholera_calender<-cholera_data %>% 
                       select(
                         sex, 
                         age_group, 
                         level_education, 
                         religion, 
                         c(48:51)
                       )

knowledge_on_cholera_calender<- knowledge_on_cholera_calender %>% 
  pivot_longer(
    cols = (5:8), 
    names_to = "knowledge_on_cholera_season"
  ) %>% 
  filter(value==1)




age_group_table<- age_group_table %>%
  rename("variable" = age_group)

education_table<- education_group %>%
  rename("variable" = level_education)

religion_table<- religion_group %>%
  rename("variable" = religion)

table17<- bind_rows(
  sex_table, 
  age_group_table,
  education_table,
  religion_table
)


table17<- table17 %>% 
  mutate(
    knowledge_on_cholera_season_in_winter=round(
    knowledge_on_cholera_season_in_winter/total*100, 2), 
    knowledge_on_cholera_season_in_summer=round(knowledge_on_cholera_season_in_summer/total*100, 2),
   knowledge_on_cholera_season_in_rainy_season =round(knowledge_on_cholera_season_in_rainy_season/total*100, 2),
    knowledge_on_cholera_season_do_not_know=round(knowledge_on_cholera_season_do_not_know/total*100, 2)
    )
  


table17<- table17 %>% 
  rename_with(~ str_replace_all(., "knowledge_on_cholera_season_", ""))


table17<- table17 %>% 
  rename_with(~ str_replace_all(., "_", " "))



table17<- table17 %>% 
  as_flextable()

save_as_docx(table17, path = here("output/table17.docx"))


# Knowledge of cholera calendar year by district




knowledge_on_cholera_calender_district<-cholera_data %>% 
                       select(
                         district, 
                         residence, 
                         zone,
                         c(48:51)
                       )








district_table<- process_data(knowledge_on_cholera_calender_district,
                              "district")

zone_table<- process_data(knowledge_on_cholera_calender_district,
                              "zone")

residence_table<- process_data(knowledge_on_cholera_calender_district,
                              "residence")



district_table<- district_table %>% 
  rename("variable" =district)

zone_table<- zone_table %>% 
  rename("variable" =zone)
residence_table<- residence_table %>% 
  rename("variable" =residence)


table18<- bind_rows(
  district_table,
zone_table,
  residence_table
)


table18<- table18 %>% 
  mutate(
    knowledge_on_cholera_season_in_winter=round(
    knowledge_on_cholera_season_in_winter/total*100, 2), 
    knowledge_on_cholera_season_in_summer=round(knowledge_on_cholera_season_in_summer/total*100, 2),
   knowledge_on_cholera_season_in_rainy_season =round(knowledge_on_cholera_season_in_rainy_season/total*100, 2),
    knowledge_on_cholera_season_do_not_know=round(knowledge_on_cholera_season_do_not_know/total*100, 2)
    )




table18<- table18 %>%
  rename_with(~ str_replace_all(., "knowledge_on_cholera_season_", ""))

table18<- table18 %>%
  rename_with(~ str_replace_all(., "_", " "))



table18<- table18 %>%
  flextable() %>%
  autofit() %>%
  set_table_properties(layout = "autofit")


save_as_docx(table18, path = here("output/table18.docx"))


```


## 2. 7. 0 Knowledge of the potential Cause of Cholera sex, Age Group, Level of Education, Religion

```{r}

knowledge_on_cholera_cause<-cholera_data %>% 
                       select(sex, 
                              age_group, 
                              level_education, 
                              religion,
                              ethnicity,  
                            contains("potential_causes_of_cholera_"),
                  -contains("potential_causes_of_cholera_other_causes")
                              )


knowledge_on_cholera_cause<- knowledge_on_cholera_cause %>% 
  pivot_longer(
    cols = (6:19), 
    names_to ="potential_causes_of_cholera"
  ) %>% 
  dplyr::filter(value==1) %>% 
  group_by(Sex, age_group, level_education, ethnicity) %>% 
  
  dplyr::select(sex, 
         age_group,
         level_education,
         religion, 
         ethnicity,
         potential_causes_of_cholera, 
         value)



knowledge_on_cholera_cause$potential_causes_of_cholera<- gsub("potential_causes_of_cholera_",
      "",
      knowledge_on_cholera_cause$potential_causes_of_cholera)


knowledge_on_cholera_cause$potential_causes_of_cholera<- gsub("_",
      " ",
      knowledge_on_cholera_cause$potential_causes_of_cholera)


table19<-knowledge_on_cholera_cause %>% 
  create_summary_table3(grouding_vars_demo, 
                        "potential_causes_of_cholera",
                        sum = T)


table19<- table19 %>%
  flextable() %>%
  autofit() %>%
  set_table_properties(layout = "autofit") %>%
  height_all(height = 0.5, unit = "in")


save_as_docx(table19, path = here("output/table19.docx"))
  



 
```


## 2. 7. 0 Knowledge of the potential by District and residence: 

```{r}


knowledge_district<-cholera_data %>% 
                       select(district,
                              residence,
                            contains("potential_causes_of_cholera_"),
                  -contains("potential_causes_of_cholera_other_causes")
                              )


knowledge_district<- knowledge_district %>% 
  pivot_longer(
    cols = (3:16), 
    names_to ="potential_causes_of_cholera"
  ) %>% 
  filter(value==1) %>% 
  select(district,
         residence,
         potential_causes_of_cholera)



knowledge_district$potential_causes_of_cholera<- gsub("potential_causes_of_cholera_",
      "",
      knowledge_district$potential_causes_of_cholera)


knowledge_district$potential_causes_of_cholera<- gsub("_",
      " ",
      knowledge_district$potential_causes_of_cholera)


table20<-knowledge_district %>% 
  create_summary_table3(grouding_vars, 
                        "potential_causes_of_cholera",
                        sum = T)


table20<- table20 %>%
  flextable() %>%
  autofit() %>%
  set_table_properties(layout = "autofit") %>%
  height_all(height = 0.5, unit = "in")


save_as_docx(table20, path = here("output/table20.docx"))

print(table20)
  



```





## 2.8. 0 Knowledge of the Prevention Measures of cholera by Sex, Level of Education and Religious Belief.  


```{r}
Prevention_of_cholera <- cholera_data %>%
         select(
           district, 
           residence, 
           c(70:82)
         )


grouping_vars <- c("district", "residence")

Prevention_of_cholera<-Prevention_of_cholera %>% 
  pivot_longer(
    cols = (3:15), 
    names_to = "prevention_of_cholera"
  ) %>% 
  filter(value==1) %>%
  select(district, 
         residence, 
         prevention_of_cholera)


Prevention_of_cholera$prevention_of_cholera<- gsub("cholera_preventation_measures_",
      "",
      Prevention_of_cholera$prevention_of_cholera)


Prevention_of_cholera$prevention_of_cholera<- gsub("_",
      " ",
      Prevention_of_cholera$prevention_of_cholera)

Prevention_of_cholera %>% 
  create_summary_table3(grouping_vars, 
                        "prevention_of_cholera",
                        sum = T) %>% 
  flextable() %>% 
  autofit() %>% 
  set_table_properties(layout = "autofit") %>% 
  height_all(height = 0.5, unit = "in") %>% 
  save_as_docx(path = here("output/table21.docx"))


```

## 2.8. 0 Knowledge of the Prevention Measures of cholera by District 
```{r}





```


## 2. 9.0 Current local measures or campaigns in place to prevent cholera outbreaks by Districts
```{r}




```

# Social and cultural behavior determinants of vaccine uptake 


## 3.1. 0 Aware of Cholera Vaccine by  Age- Group, Sex Level of Education, and 3.1. 1 Aware of Cholera Vaccine by  District and Zone




```{r}
table3.1.0 <- cholera_data |> 
            select(vaccined_with_ocv,age_group,sex,level_education)


grouping_vars <- c("age_group","sex","level_education")


table3.1.0 <-  create_summary_table2(table3.1.0,
                                     grouping_vars,"vaccined_with_ocv") |> 
                    as_flextable() |>
                    autofit() |>
                    set_table_properties(layout = "autofit")



save_as_docx( table3.1.0, path = here("output/table3_1_0.docx"))


table3.1.1 <- cholera_data |> 
            select(vaccined_with_ocv,district,residence)

grouping_vars <- c("vaccined_with_ocv","district","residence")


table3.1.1 <-  create_summary_table2(table3.1.1,grouping_vars,"vaccined_with_ocv") |> 
                    as_flextable() |>
                    autofit() |>
                    set_table_properties(layout = "autofit")

table3.1.1 <-  table3.1.1 %>%
         as_flex_table()
  as_flextable() |>
   autofit() |>
  set_table_properties(layout = "autofit")



save_as_docx( table3.1.1, path = here("output/table3_1_1.docx"))


```


## 3.2.0  Believe Cholera Vaccine Prevent Cholera by Sex, Level of Education 

```{r}
table3.2.0 <- cholera_data |> 
            select(ocv_prevent_cholera,age_group,sex,level_education)

grouping_vars <- c("age_group","sex","level_education")


table3.2.0 <-  create_summary_table2(table3.2.0,grouping_vars,"ocv_prevent_cholera") |> 
                    as_flextable() |>
                    autofit() |>
                    set_table_properties(layout = "autofit")



save_as_docx( table3.2.0, path = here("output/table3_2_0.docx"))




```

## 3.2.1  Believe Cholera Vaccine Prevent District and Zone 

```{r}

table3.2.1 <- cholera_data |> 
            select(ocv_prevent_cholera,district,residence)

grouping_vars <- c("district","residence")


table3.2.1 <-  create_summary_table2(table3.2.1,grouping_vars,"ocv_prevent_cholera") |> 
                    as_flextable() |>
                    autofit() |>
                    set_table_properties(layout = "autofit")



save_as_docx( table3.2.1, path = here("output/table3_2_1.docx"))


```

##3.3. 0 Information about Cholera Vaccine  by Sex, Age Group,  Education, Religion, Residence

```{r}
ocv_info <- cholera_data %>% 
               select(
                 sex,
                  age_group, 
                  level_education, 
                  religion,
                 c(139:151)
               )

 

sex_table<- process_data(ocv_info,"sex")
age_group_table<- process_data(ocv_info,"age_group")
education_table<- process_data(ocv_info,"level_education")
religion_table<- process_data(ocv_info,"religion")


sex_table <- sex_table %>% 
  rename(
    "variable" = sex
  )

age_group_table<- age_group_table %>% 
  rename(
    "variable"=age_group
  )


education_table<- education_table %>% 
  rename(
    "variable"=level_education
  )


religion_table<- religion_table %>% 
  rename(
    "variable"=religion
  )


# Combine all tables into one
table3.3.0 <- bind_rows(sex_table,
                     age_group_table,
                     education_table,
                     religion_table)



table3.3.0 <- table3.3.0 %>% 
  mutate(
 ocv_information_social_media= round(ocv_information_social_media/total*100, 2) ,         
ocv_information_radio= round(ocv_information_radio/total*100, 2),   

 ocv_information_print_media= round(ocv_information_print_media/total*100, 2),

 ocv_information_religious_leaders=round(ocv_information_religious_leaders/total*100, 2),    
 ocv_information_government=round(ocv_information_government/total*100, 2), 

 ocv_information_other_information = round(ocv_information_other_information/total*100, 2),     

 ocv_information_healthcare_providers= round(ocv_information_healthcare_providers/total*100, 2),

 ocv_information_friends_family  = round(ocv_information_friends_family/total*100, 2),

ocv_information_internet=round(ocv_information_internet/total*100, 2),

ocv_information_community_leaders = round(ocv_information_community_leaders/total*100, 2),
ocv_information_communication_campaign = round(ocv_information_communication_campaign/total*100, 2)#,
#other_source_of_ocv =round(other_source_of_ocv/total*100, 2)
    )




table3.3.0 <- table3.3.0 %>%
  rename_with(~ str_replace_all(., "ocv_information_", " "))

table3.3.0 <- table3.3.0 %>%
  rename_with(~ str_replace_all(., "_", " "))


table3.3.0 <- table3.3.0 %>% 
  as_flextable() |> 
   autofit() |> 
  set_table_properties(layout = "autofit")

table3.3.0

save_as_docx(table3.3.0, path = here("output/table3_3_0.docx"))



```

```{r}
residence_table
```


## 3.3. 1 Information about Cholera Vaccine  by  District and Zone 

```{r}
ocv_info <- cholera_data %>% 
               select(
                 district,
                 zone,
                 residence,
                 c(139:151)
               )

district_table<- process_data(ocv_info,"district")
age_group_table<- process_data(ocv_info,"zone")
residence_table<- process_data(ocv_info,"residence")

district_table <- district_table %>% 
  rename(
    "variable" = district
  )

zone_table<- age_group_table %>% 
  rename(
    "variable"= zone
  )


residence_table <- residence_table %>% 
  rename(
    "variable"=residence
  )

# Combine all tables into one
table3.3.1 <- bind_rows(district_table,
                     zone_table,
                     residence_table)



table3.3.1 <- table3.3.1 %>% 
  mutate(
 ocv_information_social_media= round(ocv_information_social_media/total*100, 2) ,         
ocv_information_radio= round(ocv_information_radio/total*100, 2),   

 ocv_information_print_media= round(ocv_information_print_media/total*100, 2),

 ocv_information_religious_leaders=round(ocv_information_religious_leaders/total*100, 2),    
 ocv_information_government=round(ocv_information_government/total*100, 2), 

 ocv_information_other_information = round(ocv_information_other_information/total*100, 2),     

 ocv_information_healthcare_providers= round(ocv_information_healthcare_providers/total*100, 2),

 ocv_information_friends_family  = round(ocv_information_friends_family/total*100, 2),

ocv_information_internet=round(ocv_information_internet/total*100, 2),

ocv_information_community_leaders = round(ocv_information_community_leaders/total*100, 2),
ocv_information_communication_campaign = round(ocv_information_communication_campaign/total*100, 2)#,
#other_source_of_ocv =round(other_source_of_ocv/total*100, 2)
    )




table3.3.1 <- table3.3.1 %>%
  rename_with(~ str_replace_all(., "ocv_information_", " "))

table3.3.1 <- table3.3.1 %>%
  rename_with(~ str_replace_all(., "_", " "))


table3.3.1 <- table3.3.1 %>% 
  as_flextable() |> 
   autofit() |> 
  set_table_properties(layout = "autofit")

table3.3.1

save_as_docx(table3.3.1, path = here("output/table3_3_1.docx"))


```



## 3. 4. 0 Safe of Cholera Vaccine by Sex Age Group Education and Religion 

```{r}

table3.4.0 <- cholera_data %>%
  select(sex, age_group, level_education, religion, safe_vaccine)

grouping_vars <- c("age_group","sex","level_education","religion")


table3.4.0 <-  create_summary_table2(table3.4.0,grouping_vars,"safe_vaccine") 

table3.4.0

table3.4.0 <- table3.4.0 |> 
          as_flextable() |>
          autofit() |>
          set_table_properties(layout = "autofit")



save_as_docx( table3.4.0, path = here("output/table3_4_0.docx"))


```


##3. 4. 1 Safe of Cholera Vaccine by District and Zone 

```{r}
table3.4.1 <- cholera_data |> 
            select(safe_vaccine,district,zone) %>% 
            tbl_summary(safe_vaccine,
            percent = "row",
            digits = list(
              district~ c(0, 2),
              zone ~ c(0, 2)
            ))


 
table3.4.1 <-  table3.4.1 %>% 
         as_flex_table() |>  
  as_flextable() |> 
   autofit() |> 
  set_table_properties(layout = "autofit")


save_as_docx( table3.1.1, path = here("output/table3_4_1.docx"))

table3.4.1


```

## 3. 5. 0 Community Influence decision about vaccination by District and Zone 

```{r}

cI_info <- cholera_data %>% 
               select(
                 district,
                 zone,
                 residence,
                 c(119:123)
               )

district_table<- process_data(cI_info,"district")
age_group_table<- process_data(cI_info,"zone")
residence_table<- process_data(cI_info,"residence")

district_table <- district_table %>% 
  rename(
    "variable" = district
  )

zone_table<- age_group_table %>% 
  rename(
    "variable"= zone
  )


residence_table <- residence_table %>% 
  rename(
    "variable"=residence
  )

# Combine all tables into one
table3.5.0 <- bind_rows(district_table,
                     zone_table,
                     residence_table)



table3.5.0  <- table3.5.0  %>% 
  mutate(
 decision_about_getting_vaccinated_cultural_traditional= round(decision_about_getting_vaccinated_cultural_traditional/total*100, 2) , 
 
decision_about_getting_vaccinated_religious= round(decision_about_getting_vaccinated_religious/total*100, 2),   

 decision_about_getting_vaccinated_family_pressure= round(decision_about_getting_vaccinated_family_pressure/total*100, 2),

 decision_about_getting_vaccinated_none_2=round(decision_about_getting_vaccinated_none_2/total*100, 2),    

decision_about_getting_vaccinated_other_decision=round(decision_about_getting_vaccinated_other_decision/total*100, 2), 

)


table3.5.0  <- table3.5.0  %>%
  rename_with(~ str_replace_all(., "decision_about_getting_vaccinated_", " "))

table3.5.0  <- table3.5.0  %>%
  rename_with(~ str_replace_all(., "_", " "))


table3.5.0  <- table3.5.0  |>  
  as_flextable() |> 
   autofit() |> 
  set_table_properties(layout = "autofit")

table3.5.0 

save_as_docx(table3.5.0 , path = here("output/table3_5_0.docx"))
       


```



## 3. 6. 0 Difficult in access cholera vaccination by Sex, Education and Religion  

```{r}

table3.6.0 <- cholera_data %>%
  select(sex, age_group, level_education, religion, ocv_access) %>%
  tbl_summary(
    by = ocv_access,
    statistic = list(
      sex ~ "{n} ({p}%)",
      age_group ~ "{n} ({p}%)",
      level_education ~ "{n} ({p}%)",
      religion ~ "{n} ({p}%)"
    ),
    digits = list(
      sex ~ c(0, 2),
      age_group ~ c(0, 2),
      level_education ~ c(0, 2),
      religion ~ c(0, 2)
    ),
    percent = "row"
  ) %>%
  modify_header(label = "**Demographic Variable**") %>%
  bold_labels()

# Convert to a flextable for Word export
table_safe_combined <- table3.6.0 %>%
  as_flex_table()

# Save as a Word document
save_as_docx(table3.6.0, path = here("output/table3_6_0.docx"))

table3.6.0





```


## 3. 6. 1 Difficult in access cholera vaccination by District 


```{r}

table3.6.1 <- cholera_data |> 
            select(ocv_prevent_cholera,district) %>% 
            tbl_summary(ocv_prevent_cholera,
            percent = "row",
            digits = list(
              district~ c(0, 2)
            ))


 
table3.6.1 <-  table3.6.1 %>% 
         as_flex_table()


save_as_docx( table3.6.1, path = here("output/table3_6_1.docx"))

table3.6.1


```



##3. 7. 0 OCV status by Sex, Age Group, Education and Religious 

```{r}
table3.7.0 <- cholera_data |> 
  select(sex,age_group,level_education,religion,received_ocv,residence)

grouping_vars <- c("age_group","sex","level_education","religion")


table3.7.0 <-  create_summary_table2(table3.7.0,grouping_vars,"received_ocv") 

table3.7.0

table3.7.0 <- table3.7.0 |> 
          as_flextable() |>
          autofit() |>
          set_table_properties(layout = "autofit")



save_as_docx( table3.7.0, path = here("output/table3_7_0.docx"))



table3.7.1 <- cholera_data |> 
  select(received_ocv,district,residence)

grouping_vars <- c("district","residence")


table3.7.1 <-  create_summary_table2(table3.7.1,grouping_vars,"received_ocv") 

table3.7.1

table3.7.1 <- table3.7.1 |> 
          as_flextable() |>
          autofit() |>
          set_table_properties(layout = "autofit")



save_as_docx( table3.7.1, path = here("output/table3_7_1.docx"))

```


## 3. 8. 0 Family Members vaccinated by District and Zone 
```{r}
table3.8.0 <- cholera_data |> 
            select(family_members_vaccinated,district,residence)


grouping_vars <- c("district","residence")


table3.8.0 <-  create_summary_table2(table3.8.0,grouping_vars,"family_members_vaccinated") 

table3.8.0

table3.8.0 <- table3.8.0 |> 
          as_flextable() |>
          autofit() |>
          set_table_properties(layout = "autofit")



save_as_docx( table3.8.0, path = here("output/table3_8_0.docx"))


```


## 3. 9. 0 Willingness to get vaccinated in the Future OCV by Sex, Age Group and Education 

```{r}

table3.4.1 <- cholera_data |> 
            select(safe_vaccine,district,zone) %>% 
            tbl_summary(safe_vaccine,
            percent = "row",
            digits = list(
              district~ c(0, 2),
              zone ~ c(0, 2)
            ))


 
table3.4.1 <-  table3.4.1 %>% 
         as_flex_table() |>  
  as_flextable() |> 
   autofit() |> 
  set_table_properties(layout = "autofit")


save_as_docx( table3.1.1, path = here("output/table3_4_1.docx"))

table3.4.1


```

## 3. 5. 0 Community Influence decision about vaccination by District and Zone 

```{r}

cI_info <- cholera_data %>% 
               select(
                 district,
                 zone,
                 residence,
                 c(119:123)
               )

district_table<- process_data(cI_info,"district")
age_group_table<- process_data(cI_info,"zone")
residence_table<- process_data(cI_info,"residence")

district_table <- district_table %>% 
  rename(
    "variable" = district
  )

zone_table<- age_group_table %>% 
  rename(
    "variable"= zone
  )


residence_table <- residence_table %>% 
  rename(
    "variable"=residence
  )

# Combine all tables into one
table3.5.0 <- bind_rows(district_table,
                     zone_table,
                     residence_table)



table3.5.0  <- table3.5.0  %>% 
  mutate(
 decision_about_getting_vaccinated_cultural_traditional= round(decision_about_getting_vaccinated_cultural_traditional/total*100, 2) , 
 
decision_about_getting_vaccinated_religious= round(decision_about_getting_vaccinated_religious/total*100, 2),   

 decision_about_getting_vaccinated_family_pressure= round(decision_about_getting_vaccinated_family_pressure/total*100, 2),

 decision_about_getting_vaccinated_none_2=round(decision_about_getting_vaccinated_none_2/total*100, 2),    

decision_about_getting_vaccinated_other_decision=round(decision_about_getting_vaccinated_other_decision/total*100, 2), 

)


table3.5.0  <- table3.5.0  %>%
  rename_with(~ str_replace_all(., "decision_about_getting_vaccinated_", " "))

table3.5.0  <- table3.5.0  %>%
  rename_with(~ str_replace_all(., "_", " "))


table3.5.0  <- table3.5.0  |>  
  as_flextable() |> 
   autofit() |> 
  set_table_properties(layout = "autofit")

table3.5.0 

save_as_docx(table3.5.0 , path = here("output/table3_5_0.docx"))

```


## 3. 9. 1 Willingness to get vaccinated in the Future OCV by District and Zone 

```{r}
table3.9.1 <- cholera_data |> 
            select(will_to_get_vaccinated,age_group,sex,level_education,religion)


grouping_vars <- c("age_group","sex","level_education","religion")


table3.9.1 <-  create_summary_table2(table3.9.1,grouping_vars,"will_to_get_vaccinated") 

table3.9.1

table3.9.1 <- table3.9.1 |> 
          as_flextable() |>
          autofit() |>
          set_table_properties(layout = "autofit")



save_as_docx( table3.9.1, path = here("output/table3_9_1.docx"))

```


## 3. 10. 0 Recommend a Family member to get vaccinated by District and Zone 

```{r}
table3.10.0 <- cholera_data %>% 
               select(
                 district,
                 zone,
                 residence,
                 recommend_ocv_to_family
               ) |> 
  tbl_summary(recommend_ocv_to_family,
              percent = "row",
              digits = list(
                district~c(0,2),
                zone~c(0,2)
              ))
table3.10.0

```


# 4. 0 . Sanitary services and infrastructure for Cholera prevention at community and household levels

## Sainitary Infracture we access 

```{r}

sanitary_infractures<- cholera_data %>% 
  select(toilet_facility_avaiable,
         soild_waste_disposal, 
         bath_shelter_bathroom, 
         household_handwashing_facility, 
         san_facility_unavailable, 
         soap_or_detergent_available,
         drainage_around_household,
         toilet_covered, 
         toilet_cleanliness,
         designated_kitchen_area,
         pit_condition,
         sanitary_and_infrastructure_category,
         common_reasons_not_using_san_facilities_poor_maintenance_unhygienic,            common_reasons_not_using_san_facilities_cost,
         common_reasons_not_using_san_facilities_distance
  )


summarytools::freq(sanitary_infractures)

# this code is extrating a data set on the availability of sanitary infractures in the community and household level

table_san_facility <- sanitary_infractures %>% 
  select(
    toilet_facility_avaiable,
    soild_waste_disposal,
    bath_shelter_bathroom,
    household_handwashing_facility, 
    soap_or_detergent_available,
    designated_kitchen_area
  )


table_san_facility_2<-sanitary_infractures %>%
  select(
    drainage_around_household,
    toilet_covered,
    toilet_cleanliness,
    pit_condition )



```



```{r}

## This table provide a freq on the availability of sanitary infrastructures in the community and household level

table_san_facility<- table_san_facility %>% 
  pivot_longer(
    cols = 1:6,
    names_to = "sanitary_infractures"
  ) %>% 
  count(sanitary_infractures, value) %>% 
  dplyr::filter(value != 4) %>% 
  pivot_wider(names_from = value, values_from = n, values_fill = 0) %>% 
  mutate(
    total = available + not_available,
    available = paste0(available, " (", round(available / total * 100, 1), "%)"),
    not_available = paste0(not_available, " (", round(not_available / total * 100, 1), "%)")
  ) %>% 
  select(sanitary_infractures, available, not_available)


table_san_facility<- table_san_facility %>%
  flextable() %>%
  autofit() %>%
  set_table_properties(layout = "autofit")


save_as_docx(table_san_facility, path = here("output/table_sanitary_infractures.docx"))

```



```{r}

library(dplyr)
library(tidyr)
library(ggplot2)

# List of sanitation-related variables
vars <- c("drainage_around_household", "toilet_covered", "toilet_cleanliness", "pit_condition")

# Reshape to long format
long_data <- table_san_facility_2%>%
  select(all_of(vars)) %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "response")

# Summarize counts and compute percentages
summary_data <- long_data %>%
  group_by(variable, response) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(variable) %>%
  mutate(
    percent = n / sum(n) * 100,
    label = paste0(response, " (", round(percent, 1), "%)")
  )

# Plot pie charts with response values shown
pie_chart_image<- ggplot(summary_data, aes(x = "", y = percent, fill = factor(response))) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  facet_wrap(~ variable, scales = "free") +
  geom_text(aes(label = label), position = position_stack(vjust = 0.5), size = 3) +
  labs(title = "Condition of Sanitary Infrasctures at study visit ", fill = "Response Value") +
  theme_void() +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    plot.title = element_text(hjust = 0.5, size = 16)
  )+
  theme(legend.position = "none")


ggsave(here("output/pie_chart_image.png"),
       pie_chart_image, 
       width = 10, 
       height = 10, 
       bg="white",
       dpi = 300)


```

## overall sanitary infrastructures in the community and household level


```{r}


overall_sanitary <- cholera_data %>% 
  select(sanitary_and_infrastructure_category)



pie_chart_overall_san <- overall_sanitary %>% 
  count(sanitary_and_infrastructure_category) %>% 
  rename("Overall_Sanitary_status"= sanitary_and_infrastructure_category) %>% 
  mutate(
    Overall_Sanitary_status = fct_reorder(Overall_Sanitary_status, n), 
    percent= round(n/sum(n)*100, 2)
  ) %>%
  ggplot(aes(x = "", y = percent, fill = factor(Overall_Sanitary_status))) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y")+
  geom_text(aes(label = paste0(Overall_Sanitary_status, " (", percent, "%)")), 
            position = position_stack(vjust = 0.5),
            size = 6) +
  labs(title = "Overall Sanitary Status at Study Visit") +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16)
  )+
  theme(legend.position = "none")

ggsave(here("output/pie_chart_overall_san.png"),
       pie_chart_overall_san,
       width = 10,
       height = 10,
       bg="white",
       dpi = 300)


```


## Association of sanitary and demographic variables 

```{r}

sanitary_by_person<- cholera_data %>% 
  select(
    sex,
    age_group, 
    level_education,
    religion,
    marital_status, 
    occupation, 
    ethnicity, 
    sanitary_and_infrastructure_category
  )



association_table<- sanitary_by_person|>
  tbl_summary(by=sanitary_and_infrastructure_category) |>
  add_p() |>
  add_ci()

association_table<- association_table|>
  as_flex_table()|>
  autofit()

save_as_docx(association_table, 
             path = "output/association_table.docx")



```


## Association of sanitary and place variables
```{r}


sanitary_by_place<- cholera_data %>% 
  select(
    district, 
    residence,
    sanitary_and_infrastructure_category
  )


association_table_place<- sanitary_by_place|>
  tbl_summary(by=sanitary_and_infrastructure_category) |>
  add_p() |>
  add_ci()

association_table_place <- association_table_place|>
  as_flex_table()|>
  autofit()


save_as_docx(association_table_place, 
             path = "output/association_table_place.docx")


```

# Map of Study Sites

```{r}

# Define study site districts
study_sites <- c("Blantyre", "Lilongwe", "Balaka", "Nkhata Bay", "Salima", "Mangochi", "Dedza")

# Create a new column to categorize districts
ta_shapefile$SiteType <- ifelse(ta_shapefile$District %in% study_sites, "Study site", "Other")

study_site_map<-tm_shape(ta_shapefile) +
  tm_polygons(col = "SiteType",
              palette = c("Study site" = "green", 
                          "Other" = "white"), 
              title = "Site Type", border.col = "gray") +
  tm_text("District", size = 0.8) +
  tm_layout(legend.position = c("left", "bottom"), 
            legend.bg.color = "white", 
            legend.text.size = 0.5)

tmap_save(study_site_map,
        filename = here("output/study_site_map.png"), 
      width = 10, height = 10, dpi = 300)

```


# spatial analysis of the availabiliyt of the sanitaty infrastructure by TA(PAMI). 

```{r}

# Load the shapefile for the TA boundaries


ta_shapefile<- st_read(here("data/mw_shp/mwi_admbnda_adm3_nso_hotosm_20230405.shp")) |>
  rename("ta" = ADM3_EN, 
         "district"=ADM2_EN)|>
  select(
  district, 
  ta)




sanitary_by_ta <- cholera_data %>% 
  select(
    district, 
    ta,
    sanitary_and_infrastructure_category
  )|>
  mutate(
    ta=recode(
      ta, 
      "TA_Msosa"="TA_Karonga", 
     "TA_Amidu"= "TA_Kalembo",
      "TA_Chanthunya"="TA_Nsamala",
     "TA_Nkaya"="TA_Nsamala",
     "TA_Msamala"="TA_Nsamala", 
     "TA_Phalula"="TA_Nsamala", 
     "Limbe_Central_ward"="Blantyre_City", 
     "Blantyre_City_Centre_ward"="Blantyre_City", 
     "SC_Kambwiri"="TA_Kambwiri", 
     "SC_Mwanza"="TA_Mwanza", 
     "SC_Kambalame"="TA_Kambalame", 
     "TA_Lundu_blantye"="TA_Lundu", 
     "SC_Tsabango"="TA_Tsabango",
      "SC_Njewa"= "TA_Njewa", 
     "SC_Kamenya_Gwaza"="TA_Kamenya_gwaza", 
     "SC_Namabvi"="TA_Namabvi",
      "SC_Chowe"="TA_Chowe", 
      "SC_Zilakoma"="TA_Zilakoma",
      "SC_Fukamalaza"="TA_Fukamalaza"
        )  )

sanitary_by_ta$ta<- gsub("_", " ", sanitary_by_ta$ta)


sanitary_by_ta<- sanitary_by_ta|>
  count(district, ta, sanitary_and_infrastructure_category)|>
  pivot_wider(names_from = sanitary_and_infrastructure_category, 
              values_from = n)|>
  mutate(
   total= Adequate + Inadequate,
    Adequate= round(
      Adequate/total*100, 2
    ) )|>
  select(
    district, 
    ta, 
    Adequate
  )



merged_san_ta<- merge(ta_shapefile,
                      sanitary_by_ta,
                      by = "ta")
 
    



tm_shape(ta_shapefile)+
tmap_options(check.and.fix = T)+
tm_borders(col = "skyblue")+
  tm_shape(district_shapefile)+
  tm_borders(col = "black")+
tm_shape(merged_san_ta)+
tm_polygons(col = "Adequate", 
            palette = "green", 
            style = "count", 
            title = "Sanitary Infrastructure Availability (%)")







```


```{r}


library(tmap)

# Set tmap to plotting mode (you can switch to view mode if desired)
tmap_mode("plot")

sanitary_infrastructure_map<- tm_shape(ta_shapefile) +
  tmap_options(check.and.fix = TRUE) +
  tm_borders(col = "skyblue", lwd = 1) +

  tm_shape(merged_san_ta) +
  tm_polygons(
    col = "Adequate",                     
    palette = "YlGn",                     
    style = "quantile",                   
    n = 5,                                
    title = "Sanitary Infrastructure\nAvailability (%) in PAMI",
    border.col = "grey60",                
    textNA = "No data",                   
    colorNA = "lightgrey"
  ) +
   tm_layout(
    legend.outside = TRUE,
    legend.title.size = 1.1,
    legend.text.size = 0.8,
    frame = FALSE,
    main.title = "Spatial Distribution of Sanitary Infrastructure Availability",
    main.title.size = 1.2
  )+
   tm_shape(district_shapefile) +
  tm_borders(col = "black", lwd = 1.2) +
  tm_text("District", size = 0.7)



tmap_save(
  filename = 
    here("output/sanitary_infrastructure_map.png"),
  width = 10,
  height = 10,
  dpi = 300
)




```
































































